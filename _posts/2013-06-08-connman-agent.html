---
layout: post
title: connman的agent实现原理简述
tags: [Connman,WiFi]
---
当进行wifi连接时，会需要提供密码等信息。这就需要有一个可实现的交互机制。
<!--break-->
<br>connman的处理方法是，要求客户端程序按着api-agent.txt的要求，自己实现一个dbus接口，挂在system bus上面。<br>实际上就是一种回调机制。当connman需要客户数据时，就会调用agent的接口去向用户索取。<br><br>下面总结一下通过gdbus和c语言实现与connman的交互。<br>这里主要是在进行wifi的连接认证工作。<br><br>其实就是实现了一个最简单版本的simple-agent。<br>主要做了两件事情：<br>1、注册Agent<br>2、当接受到connman来的请求时，做成密码信息发送回去<br><br>下面的代码用于实现目的一，也就是注册Agent。<br>这里是借助connman-manager.xml生成的gdbus接口。<br>首先，需要挂到connman的dbus上。注意，需要挂到system bus。<br><pre class="brush: c; gutter: true; first-line: 1; highlight: []; html-script: false"><br>    GDBusConnection * c;<br>    NetConnmanManager   *proxy;<br>    GError *err = NULL;<br>    <br>    c = g_bus_get_sync (G_BUS_TYPE_SYSTEM, NULL, &amp;err);<br>    proxy = net_connman_manager_proxy_new_sync(c, <br>                G_DBUS_PROXY_FLAGS_NONE, <br>                &quot;net.connman&quot;, <br>                &quot;/&quot;, <br>                NULL, <br>                &amp;err);<br></pre><br><br>然后就是注册，同样的借助connman-manager.xml生成的gdbus接口。<br><pre class="brush: c; gutter: true; first-line: 1; highlight: []; html-script: false">    net_connman_manager_call_register_agent_sync(<br>        proxy, <br>        path, // something like &quot;/net/connman/service/wifi_xxxxx_yyyyy_managed_psk&quot;<br>        NULL,<br>        &amp;error);<br></pre><br><br>其次，起到关键作用的就是这个RequestInput函数了。<br>生成密码信息，并且返回给connman。<br><pre class="brush: c; gutter: true; first-line: 1; highlight: []; html-script: false">static gboolean on_handle_request_input (  <br>            NetConnmanAgent *object,<br>            GDBusMethodInvocation *invocation,<br>            const gchar *arg_unnamed_arg0,<br>            GVariant *arg_unnamed_arg1,<br>            gpointer user_data)<br>{<br>    gchar * value[PASS_MAX];<br>	<br>    scanf(&quot;%s&quot;, value);<br><br>    GVariantBuilder * _builder = g_variant_builder_new(G_VARIANT_TYPE(&quot;a{sv}&quot;));<br><br>    GVariant *_value = g_variant_new(&quot;s&quot;, value);<br>    g_variant_builder_add (_builder, &quot;{sv}&quot;, &quot;Passphrase&quot;, _value);<br>    GVariant *res = g_variant_new(&quot;a{sv}&quot;, _builder);<br>    <br>    net_connman_agent_complete_request_input( object, invocation, res );<br>    <br>    return TRUE;<br>}<br></pre><br>最后附上xml文件和使用方法：<br><strong>connman-agent.xml</strong><br><pre class="brush: xml; gutter: true; first-line: 1; highlight: []; html-script: false">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;<br><br>&lt;node name=&quot;/test/Agent&quot;&gt;<br>  &lt;interface name=&quot;net.connman.Agent&quot;&gt;<br>    &lt;method name=&quot;ReportError&quot;&gt;<br>       &lt;annotation name=&quot;org.freedesktop.DBus.GLib.Async&quot; value=&quot;true&quot;/&gt;<br>       &lt;arg type=&quot;o&quot; direction=&quot;in&quot;/&gt;<br>       &lt;arg type=&quot;s&quot; direction=&quot;in&quot;/&gt;<br>    &lt;/method&gt;<br><br>    &lt;method name=&quot;RequestInput&quot;&gt;<br>      &lt;annotation name=&quot;org.freedesktop.DBus.GLib.Async&quot; value=&quot;true&quot;/&gt;<br>      &lt;arg type=&quot;o&quot; direction=&quot;in&quot;/&gt;<br>      &lt;arg type=&quot;a{sv}&quot; direction=&quot;in&quot;/&gt;<br>      &lt;arg type=&quot;a{sv}&quot; direction=&quot;out&quot;/&gt;<br>    &lt;/method&gt;<br><br>    &lt;method name=&quot;RequestBrowser&quot;&gt;<br>      &lt;annotation name=&quot;org.freedesktop.DBus.GLib.Async&quot; value=&quot;true&quot;/&gt;<br>      &lt;arg type=&quot;o&quot; direction=&quot;in&quot;/&gt;<br>      &lt;arg type=&quot;s&quot; direction=&quot;in&quot;/&gt;<br>    &lt;/method&gt;<br><br>    &lt;method name=&quot;Cancel&quot;&gt;<br>      &lt;annotation name=&quot;org.freedesktop.DBus.GLib.Async&quot; value=&quot;&quot;/&gt;<br>    &lt;/method&gt;<br><br>    &lt;method name=&quot;Release&quot;&gt;<br>      &lt;annotation name=&quot;org.freedesktop.DBus.GLib.Async&quot; value=&quot;&quot;/&gt;<br>   &lt;/method&gt;<br>  &lt;/interface&gt;<br>&lt;/node&gt;<br></pre><br><br><strong>connman-manager.xml</strong><br><pre class="brush: xml; gutter: true; first-line: 1; highlight: []; html-script: false">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;<br><br>&lt;node name=&quot;/&quot;&gt;<br>  &lt;interface name=&quot;net.connman.Manager&quot;&gt;<br>	&lt;method name=&quot;RegisterAgent&quot;&gt;<br>		&lt;arg name=&quot;path&quot; type=&quot;o&quot; direction=&quot;in&quot;/&gt;<br>	&lt;/method&gt;<br>	&lt;method name=&quot;UnregisterAgent&quot;&gt;<br>		&lt;arg name=&quot;path&quot; type=&quot;o&quot; direction=&quot;in&quot;/&gt;<br>	&lt;/method&gt;<br>  &lt;/interface&gt;<br>&lt;/node&gt;</pre><br><br>使用方法：<br><pre class="brush: shell; gutter: true; first-line: 1; highlight: []; html-script: false">gdbus-codegen  --generate-c-code net_connman_agent connman-agent.xml<br>gdbus-codegen  --generate-c-code net_connman_manager connman-manager.xml</pre><br><br>追记：<br>可以通过下面命令查询任意dbus接口的详细信息：<br><pre class="brush: shell; gutter: true; first-line: 1; highlight: []; html-script: false">dbus-send --session --type=method_call --print-reply --dest=com.xxx.yyy /com/xxx/yyy org.freedesktop.DBus.Introspectable.Introspect</pre>