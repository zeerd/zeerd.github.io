---
layout: post
title: 利用VPS实现网页打包下载或邮寄
tags: [Offline]
categories: [Website]
---
我们在很多时候由于各种原因而无法访问一些google搜索到的网页，这里提供一种利用vps系统进行远程打包下载服务的方法。<br>
<!--break-->
主要是借用php的exec函数，调用wget获取页面文件、调用tar进行打包，然后提供下载链接或者直接发送到指定邮箱。<br><br>以基于lnmp的php为例。<br><br>由于lnmp里面的php默认是关闭exec函数的，所以首先需要开启：<br>vim  /usr/local/php/etc/php.ini<br>在里面搜索“disable_func”，然后删除其中的exec并重启php服务。<br>/etc/init.d/php-fpm restart<br><br>完成之后，将下面的php页面放入www的路径中。lnmp下的默认路径为/home/wwwroot/default<br>我这里将其命名为get_web.php<br><pre class="brush: php; gutter: true; first-line: 1; highlight: []; html-script: false"><br>&lt;?php<br>function mail_attachment($to, $subject, $message, $from, $file) {<br>  // $file should include path and filename<br>  $filename = basename($file);<br>  $file_size = filesize($file);<br>  $content = chunk_split(base64_encode(file_get_contents($file)));<br>  $uid = md5(uniqid(time()));<br>  $from = str_replace(array(&quot;\\r&quot;, &quot;\\n&quot;), &#039;&#039;, $from); // to prevent email injection<br>  $header = &quot;From: &quot;.$from.&quot;\\r\\n&quot;<br>      .&quot;MIME-Version: 1.0\\r\\n&quot;<br>      .&quot;Content-Type: multipart/mixed; boundary=\\&quot;&quot;.$uid.&quot;\\&quot;\\r\\n\\r\\n&quot;<br>      .&quot;This is a multi-part message in MIME format.\\r\\n&quot;<br>      .&quot;--&quot;.$uid.&quot;\\r\\n&quot;<br>      .&quot;Content-type:text/plain; charset=iso-8859-1\\r\\n&quot;<br>      .&quot;Content-Transfer-Encoding: 7bit\\r\\n\\r\\n&quot;<br>      .$message.&quot;\\r\\n\\r\\n&quot;<br>      .&quot;--&quot;.$uid.&quot;\\r\\n&quot;<br>      .&quot;Content-Type: application/octet-stream; name=\\&quot;&quot;.$filename.&quot;\\&quot;\\r\\n&quot;<br>      .&quot;Content-Transfer-Encoding: base64\\r\\n&quot;<br>      .&quot;Content-Disposition: attachment; filename=\\&quot;&quot;.$filename.&quot;\\&quot;\\r\\n\\r\\n&quot;<br>      .$content.&quot;\\r\\n\\r\\n&quot;<br>      .&quot;--&quot;.$uid.&quot;--&quot;;<br>  return mail($to, $subject, &quot;&quot;, $header);<br> }<br>?&gt;<br><br>&lt;html&gt;<br> &lt;head&gt;<br>  &lt;title&gt;download web site&lt;/title&gt;<br> &lt;/head&gt;<br> &lt;body&gt;<br> &lt;?php<br>   $web_url = $_GET[&quot;url&quot;];<br>   $mailto = $_GET[&quot;mail&quot;];<br>   $work_dir = exec(&#039;pwd&#039;) . &#039;/tar_web/&#039;;<br>   $tgt_dir_sub = md5($web_url) .&#039;_&#039; . date(&quot;YmdHis&quot;);<br>   $tgt_dir = &#039;/tmp/&#039; . $tgt_dir_sub;<br>   $tgt_tar_name =  $tgt_dir_sub . &#039;.tar.gz&#039;;<br>   $tgt_tar =  $work_dir . $tgt_tar_name;<br>   $cmd_mkdir = &#039;mkdir &#039; . $tgt_dir;<br>   $cmd_wget = &#039;wget -k -p --directory-prefix=&#039; . $tgt_dir . &#039; &#039; . $web_url;<br>   $cmd_tar = &#039;tar czf &#039; . $tgt_tar . &#039; &#039; . $tgt_dir;<br>   $cmd_clean = &#039;rm -rf &#039; . $tgt_dir;<br>   #echo $cmd_mkdir . &quot;&lt;br&gt;&quot;;<br>   exec($cmd_mkdir);<br>   #echo $cmd_wget . &quot;&lt;br&gt;&quot;;<br>   exec($cmd_wget);<br>   #echo $cmd_tar . &quot;&lt;br&gt;&quot;;<br>   exec($cmd_tar);<br>   #echo $cmd_clean . &#039;&lt;br&gt;&#039;;<br>   exec($cmd_clean);<br><br>   $mail_len = strlen($mailto);<br>   if($mail_len == 0){<br>     echo $web_url . &#039; --&gt; &#039; . &#039;&lt;a href=&quot;tar_web/&#039; . $tgt_tar_name . &#039;&quot;&gt;download&lt;/a&gt;&#039;;<br>   }<br>   else{<br>     mail_attachment($mailto, &quot;download web site&quot;, $web_url, &quot;root@your_host&quot;, $tgt_tar);<br>   }<br>   echo &#039;&lt;p&gt;Done!&lt;/p&gt;&#039;;<br> ?&gt;<br> &lt;/body&gt;<br>&lt;/html&gt;<br></pre><br><br>使用时：<br>首先手动创建一个tar_web路径，在/home/wwwroot/default下面。<br>然后在浏览器中输入：<br>http://your_host/get_web.php?url=http://www.zeerd.com<br>或者<br>http://your_host/get_web.php?url=http://www.zeerd.com&mail=your_mail@gmail.com<br><br>注意：<br>初学者常犯的错误，使用root账号进行操作，结果www目录下的文件和文件夹的所有者都是root，导致php运行失败。<br>定期清理一下tar.gz文件。当然，也可以加一个后台页面用数据库管理，不过就目前来说功能已经足够使用了，暂时不考虑了。<br>代码中的mail_attachment函数来自：http://stackoverflow.com/a/4586659/2838940<br>另外，测试时发现一些网址只要出现在url中就会被重置，此时需要借助短地址等方式进行一下修饰。