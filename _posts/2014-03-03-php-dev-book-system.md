---
layout: post
title: 基于PHP和Sqlite3的简易设备预订系统
tags: [PHP,Sqlite,SQL]
---
<!--break-->
首先是要准备一个数据库，参照下面的sql语句创建：<br><br><pre class="brush: sql; gutter: true; first-line: 1; highlight: []; html-script: false"><br>PRAGMA foreign_keys=OFF;<br>BEGIN TRANSACTION;<br>CREATE TABLE &quot;sets&quot; (<br>    &quot;set_id&quot; INTEGER PRIMARY KEY NOT NULL DEFAULT (0),<br>    &quot;name&quot; TEXT NOT NULL DEFAULT (&#039;&quot;&quot;&#039;)<br>);<br>INSERT INTO &quot;sets&quot; VALUES(1,&#039;Equip1&#039;);<br>INSERT INTO &quot;sets&quot; VALUES(2,&#039;Equip2&#039;);<br>INSERT INTO &quot;sets&quot; VALUES(3,&#039;Equip3&#039;);<br>INSERT INTO &quot;sets&quot; VALUES(4,&#039;Equip4&#039;);<br>CREATE TABLE &quot;users&quot; (<br>    &quot;ip&quot; TEXT NOT NULL DEFAULT (&#039;127.0.0.1&#039;),<br>    &quot;name&quot; TEXT NOT NULL<br>);<br>CREATE TABLE &quot;records&quot; (<br>    &quot;book_user&quot; TEXT NOT NULL,<br>    &quot;book_date&quot; TEXT NOT NULL,<br>    &quot;book_time&quot; TEXT NOT NULL,<br>    &quot;set_name&quot; TEXT NOT NULL<br>);<br>CREATE TABLE &quot;times&quot; (<br>    &quot;time_section&quot; TEXT NOT NULL,<br>    &quot;id&quot; INTEGER PRIMARY KEY NOT NULL<br>);<br>INSERT INTO &quot;times&quot; VALUES(&#039;9:00 - 12:00&#039;,1);<br>INSERT INTO &quot;times&quot; VALUES(&#039;13:00 - 18:00&#039;,2);<br>CREATE VIEW &quot;record_all&quot; AS select records.*, times.id as book_time_id from records left join times on times.time_section=records.book_time;<br>CREATE UNIQUE INDEX unique_index_ip_in_users on users (ip ASC);<br>COMMIT;<br></pre><br><br>其次，需要一个页面用来显示设备的列表及预订信息。<br>在首次使用这个系统的时候，会先要求用户输入一个名字并绑定到客户IP上。<br><b>index.html</b><br/><br><pre class="brush: php; gutter: true; first-line: 1; highlight: []; html-script: false"><br>&lt;html&gt;<br>&lt;head&gt;<br>&lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt;<br><br>&lt;style type=&quot;text/css&quot;&gt;<br>form {<br> margin-bottom: 0px;<br>}<br>&lt;/style&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br><br>&lt;?php<br><br>$db = new SQLite3(&#039;db/equip_booking.db&#039;, 6);<br><br><br>$weekday = array(&quot;日&quot;, &quot;一&quot;, &quot;二&quot;, &quot;三&quot;, &quot;四&quot;, &quot;五&quot;, &quot;六&quot;);<br>$time = array();<br>$equip = array();<br><br>$sql = &quot;select name from users where ip=&#039;&quot;.get_client_ip().&quot;&#039;&quot;;<br>$result = $db-&gt;query($sql);<br>$row = $result-&gt;fetchArray();<br>$user_name=$row[&#039;name&#039;];<br>	<br>$result = $db-&gt;query(&quot;select time_section from times&quot;);<br>$i=0;<br>while ($row = $result-&gt;fetchArray())<br>{<br>	$time[$i] = $row[&#039;time_section&#039;];<br>	$i = $i + 1;<br>}<br>	<br>$result = $db-&gt;query(&quot;select set_id, name from sets&quot;);<br>$i=0;<br>while ($row = $result-&gt;fetchArray())<br>{<br>	$equip[$i] = $row[&#039;name&#039;];<br>	$i = $i + 1;<br>}<br><br>function get_client_ip()<br>{<br>	if ($_SERVER[&#039;REMOTE_ADDR&#039;]) {<br>		$cip = $_SERVER[&#039;REMOTE_ADDR&#039;];<br>	} elseif (getenv(&quot;REMOTE_ADDR&quot;)) {<br>		$cip = getenv(&quot;REMOTE_ADDR&quot;);<br>	} elseif (getenv(&quot;HTTP_CLIENT_IP&quot;)) {<br>		$cip = getenv(&quot;HTTP_CLIENT_IP&quot;);<br>	} else {<br>		$cip = &quot;unknown&quot;;<br>	}<br>	return $cip;<br>}<br>?&gt;<br><br><br>&lt;?php<br><br>if($user_name == &quot;&quot;){<br>	echo &quot;&lt;form action=\\&quot;user.php\\&quot; method=\\&quot;post\\&quot;&gt;&quot;;<br>		echo &quot;你的IP地址是：&quot;;<br>		echo &quot;&lt;input type=\\&quot;text\\&quot; name=\\&quot;user_ip\\&quot; readonly=true value=\\&quot;&quot;.get_client_ip().&quot;\\&quot;/&gt;&quot;;<br>		echo &quot;&lt;br/&gt;&quot;;<br>		echo &quot;请输入你的真实姓名：&quot;;<br>		echo &quot;&lt;input type=\\&quot;text\\&quot; name=\\&quot;user_name\\&quot; /&gt;&quot;;<br>		echo &quot;&lt;input type=\\&quot;submit\\&quot; name=\\&quot;submit\\&quot; value=\\&quot;提交\\&quot; /&gt;&quot;;<br>	echo &quot;&lt;/form&gt;&quot;;<br>}<br>else{<br>	echo &quot;&lt;form action=\\&quot;user.php\\&quot; method=\\&quot;post\\&quot;&gt;&quot;;<br>		echo &quot;你好，&quot;.$user_name.&quot;！&quot;;<br>		echo &quot;&lt;input type=\\&quot;hidden\\&quot; name=\\&quot;user_ip\\&quot; readonly=true value=\\&quot;&quot;.get_client_ip().&quot;\\&quot;/&gt;&quot;;<br>		echo &quot;（实际上，我是&quot;;<br>		echo &quot;&lt;input type=\\&quot;text\\&quot; name=\\&quot;user_name\\&quot; /&gt;&quot;;<br>		echo &quot;&lt;input type=\\&quot;submit\\&quot; name=\\&quot;submit\\&quot; value=\\&quot;更名\\&quot; /&gt;&quot;;<br>		echo &quot;）&quot;;<br>	echo &quot;&lt;/form&gt;&quot;;<br>	echo &quot;&lt;hr/&gt;&quot;;<br><br>	echo &quot;&lt;table border=1&gt;&quot;;<br>	echo &quot;&lt;tr&gt;&quot;;<br>	echo &quot;&lt;th&gt;&lt;/th&gt;&quot;;<br><br>	$equip_count = 0;<br>	foreach ($equip as $value){<br>		echo &quot;&lt;th&gt;&quot;. $value .&quot;&lt;/th&gt;&quot;;<br>		$equip_count++;<br>	}<br><br>	echo &quot;&lt;th&gt;日期&lt;/th&gt;&quot;;<br>	echo &quot;&lt;/tr&gt;&quot;;<br><br>	$day_max = 3;<br>	if(date(&quot;w&quot;) &gt;= 4){<br>		$day_max += 2;<br>		}<br>	for($i=0;$i&lt;$day_max;$i++){<br>		$data = mktime(0,0,0,date(&quot;m&quot;),date(&quot;d&quot;)+$i,date(&quot;Y&quot;));<br>		foreach ($time as $time_value){<br>			echo &quot;&lt;tr&gt;&quot;;<br>			echo &quot;&lt;td&gt;&quot;.$time_value.&quot;&lt;/td&gt;&quot;;<br>			foreach ($equip as $value){<br>				echo &quot;&lt;td&gt;&quot;;<br>				$sql = &quot;select book_user from records &quot;.<br>					&quot;where set_name=&#039;&quot;.$value.&quot;&#039; and book_date=&#039;&quot;.date(&quot;Y-m-d&quot;, $data).&quot;&#039; and book_time=&#039;&quot;.$time_value.&quot;&#039;&quot;;<br>				$result = $db-&gt;query($sql);<br>				$row = $result-&gt;fetchArray();<br>				$book_user = $row[&#039;book_user&#039;];<br>				if($book_user == &quot;&quot;){<br>					echo &quot;&lt;form action=\\&quot;book.php\\&quot; method=\\&quot;post\\&quot;&gt;&quot;;<br>						echo &quot;&lt;input type=\\&quot;hidden\\&quot; name=\\&quot;user\\&quot; value=\\&quot;&quot;.$user_name.&quot;\\&quot;/&gt;&quot;;<br>						echo &quot;&lt;input type=\\&quot;hidden\\&quot; name=\\&quot;data\\&quot; value=\\&quot;&quot;.date(&quot;Y-m-d&quot;, $data).&quot;\\&quot;/&gt;&quot;;<br>						echo &quot;&lt;input type=\\&quot;hidden\\&quot; name=\\&quot;time\\&quot; value=\\&quot;&quot;.$time_value.&quot;\\&quot;/&gt;&quot;;<br>						echo &quot;&lt;input type=\\&quot;hidden\\&quot; name=\\&quot;equip\\&quot; value=\\&quot;&quot;.$value.&quot;\\&quot;/&gt;&quot;;<br>						echo &quot;&lt;input type=\\&quot;submit\\&quot; name=\\&quot;submit\\&quot; value=\\&quot;预定\\&quot; /&gt;&quot;;<br>					echo &quot;&lt;/form&gt;&quot;;<br>				}<br>				else if($book_user == $user_name){<br>					echo $book_user.&quot;(&lt;a href=\\&quot;cancel.php?user=&quot;.$user_name.&quot;&amp;data=&quot;.date(&quot;Y-m-d&quot;, $data).&quot;&amp;time=&quot;.$time_value.&quot;&amp;equip=&quot;.$value.&quot;\\&quot;&gt;取消&lt;/a&gt;)&quot;;<br>				}<br>				else{<br>					echo &quot;&lt;b&gt;&quot;.$book_user.&quot;&lt;/b&gt;&quot;;<br>				}<br>				echo &quot;&lt;/td&gt;&quot;;<br>			}<br>			echo &quot;&lt;td&gt;&quot;. date(&quot;Y-m-d&quot;, $data) .&quot;(&quot;.$weekday[date(&quot;w&quot;, $data)].&quot;)&lt;/td&gt;&quot;;<br>			echo &quot;&lt;/tr&gt;&quot;;<br>		}<br>		<br>		for($ec=0;$ec&lt;$equip_count+2;$ec++){<br>			echo &quot;&lt;td&gt;&lt;hr&gt;&lt;/td&gt;&quot;;<br>		}<br>	}<br>	echo &quot;&lt;/table&gt;&quot;;<br><br>}<br>?&gt;<br><br><br>&lt;/body&gt;<br>&lt;/html&gt;<br></pre><br><br>接下来这个页面用来进行用户的绑定：<br><b>user.php</b><br/><br><pre class="brush: php; gutter: true; first-line: 1; highlight: []; html-script: false"><br>&lt;html&gt;<br>&lt;head&gt;<br>&lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;?php <br><br>$db = new SQLite3(&#039;db/equip_booking.db&#039;, 6);<br><br>$sql = &quot;replace into users values(&#039;&quot;.$_POST[&#039;user_ip&#039;].&quot;&#039;, &#039;&quot;.$_POST[&#039;user_name&#039;].&quot;&#039;)&quot;;<br>//echo $sql;<br>$db-&gt;query($sql);<br><br>echo &quot;&lt;a href=\\&quot;index.php\\&quot;&gt;返回&lt;/a&gt;&quot;;<br><br>?&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></pre><br><br>接下来这个页面用于进行设备预订：<br><b>book.php</b><br/><br><pre class="brush: php; gutter: true; first-line: 1; highlight: []; html-script: false"><br>&lt;html&gt;<br>&lt;head&gt;<br>&lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;?php<br><br>$booked_sets = array();<br>$booked_times = array();<br><br>$db = new SQLite3(&#039;db/equip_booking.db&#039;, 6);<br><br>$user_in = $_POST[&#039;user&#039;];<br>$data_in = $_POST[&#039;data&#039;];<br>$time_in = $_POST[&#039;time&#039;];<br>$equip_in = $_POST[&#039;equip&#039;];<br><br>$db-&gt;query(&quot;begin transaction&quot;);<br><br>$sql = &quot;select book_time_id from record_all where book_time=&#039;&quot;.$time_in.&quot;&#039;&quot;;<br>$result = $db-&gt;query($sql);<br>$row = $result-&gt;fetchArray();<br>$book_time_id = (int)$row[&#039;book_time_id&#039;];<br><br><br><br>if($book_time_id &gt; 1){<br>	$sql = &quot;select set_name, book_time from record_all &quot;;<br>	$sql = $sql.&quot;where book_date=&#039;&quot;.$data_in.&quot;&#039; and book_user=&#039;&quot;.$user_in.&quot;&#039; &quot;;<br>	$sql = $sql.&quot;	and (book_time_id=&quot;.($book_time_id+1).&quot; or book_time_id=&quot;.($book_time_id-1).&quot;)&quot;;<br>	//echo $sql.&quot;&lt;br/&gt;&quot;;<br>	$result = $db-&gt;query($sql);<br>	$book_user_count = 0;<br>	while ($row = $result-&gt;fetchArray())<br>	{<br>		$booked_sets[$book_user_count] = $row[&#039;set_name&#039;];<br>		$booked_times[$book_user_count] = $row[&#039;book_time&#039;];<br>		$book_user_count++;<br>	}<br>}<br>else{<br>	$sql = &quot;select set_name, book_time from record_all &quot;;<br>	$sql = $sql.&quot;where book_date=&#039;&quot;.$data_in.&quot;&#039; and book_user=&#039;&quot;.$user_in.&quot;&#039; &quot;;<br>	$sql = $sql.&quot;	and (book_time_id=&quot;.($book_time_id+1).&quot;)&quot;;<br>	//echo $sql.&quot;&lt;br/&gt;&quot;;<br>	$result = $db-&gt;query($sql);<br>	$book_user_count = 0;<br>	while ($row = $result-&gt;fetchArray())<br>	{<br>		$booked_sets[$book_user_count] = $row[&#039;set_name&#039;];<br>		$booked_times[$book_user_count] = $row[&#039;book_time&#039;];<br>		$book_user_count++;<br>	}<br>}<br><br>if($book_user_count != 0){<br>	echo &quot;&lt;a href=\\&quot;index.php\\&quot;&gt;你已经预订了&quot;;<br>	for($i=0;$i&lt;$book_user_count;$i++){<br>		echo &quot;[“&quot;.$booked_times[$i].&quot;”的“&quot;.$booked_sets[$i].&quot;”]&quot;;<br>	}<br>	echo &quot;，请不要连续预定！&lt;/a&gt;&quot;;<br>}<br>else{<br>	$sql = &quot;select book_user from records where book_date=&#039;&quot;.$data_in.&quot;&#039; and book_time=&#039;&quot;.$time_in.&quot;&#039; and set_name=&#039;&quot;.$equip_in.&quot;&#039;&quot;;<br>	$result = $db-&gt;query($sql);<br>	$row = $result-&gt;fetchArray();<br>	$book_user = $row[&#039;book_user&#039;];<br><br>	if($book_user == &quot;&quot;){<br>		$sql = &quot;insert into records values(&#039;&quot;.$user_in.&quot;&#039;, &#039;&quot;.$data_in.&quot;&#039;, &#039;&quot;.$time_in.&quot;&#039;, &#039;&quot;.$equip_in.&quot;&#039;)&quot;;<br>		$db-&gt;query($sql);<br>	}<br><br>	$db-&gt;query(&quot;commit transaction&quot;);<br><br>	if($book_user == &quot;&quot;){<br>		echo &quot;&lt;a href=\\&quot;index.php\\&quot;&gt;返回&lt;/a&gt;&quot;;<br>	}<br>	else{<br>		echo &quot;&lt;a href=\\&quot;index.php\\&quot;&gt;啊！晚了一步。已经被&quot;.$book_user.&quot;预订了。&lt;/a&gt;&quot;;<br>	}<br>}<br><br>?&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></pre><br><br>最后这页面实在不需要的时候取消预定的：<br><b>cancel.php</b><br/><br><pre class="brush: php; gutter: true; first-line: 1; highlight: []; html-script: false"><br>&lt;html&gt;<br>&lt;head&gt;<br>&lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;?php<br><br>$db = new SQLite3(&#039;db/equip_booking.db&#039;, 6);<br><br>$sql = &quot;delete from records where book_user=&#039;&quot;.$_GET[&#039;user&#039;].&quot;&#039; and book_date=&#039;&quot;.$_GET[&#039;data&#039;].&quot;&#039; and book_time=&#039;&quot;.$_GET[&#039;time&#039;].&quot;&#039; and set_name=&#039;&quot;.$_GET[&#039;equip&#039;].&quot;&#039;&quot;;<br>//echo $sql;<br>$db-&gt;query($sql);<br><br>echo &quot;&lt;a href=\\&quot;index.php\\&quot;&gt;返回&lt;/a&gt;&quot;;<br>?&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></pre>
