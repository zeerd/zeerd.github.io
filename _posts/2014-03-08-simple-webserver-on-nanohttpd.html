---
layout: post
title: 使用NanoHttpd实现简易WebServer
tags: [WebServer,NanoHttpd]
categories: [Android]
---
<a title="NanoHTTPD" href="https://github.com/NanoHttpd/nanohttpd" target="_blank">NanoHTTPD</a>是一个基于Java的简易Webserver实现，使用BSD授权。<br><br>我们可以在Android程序中通过NanoHTTPD实现一个简易的WebServer来达成某些需要——比如期望实现一个DLNA的DMS，正如WireMe中所做的那样。<br>
<!--break-->
<br>这里，我将会给出来一个简单的例子实现。<br><br>首先，我们要实现一个继承于NanoHTTPD的WebServer Class。<br><br>假设我们的网页文件要存储在assets目录下，因此我需要一个AssetManager类成员变量来存储指针。<br><pre class="brush: java; gutter: true; first-line: 1; highlight: []; html-script: false"><br>public class SimpleServer extends NanoHTTPD {<br>    AssetManager asset_mgr;<br>    <br>    public SimpleServer() {<br>        // 端口是8088，也就是说要通过http://127.0.0.1:8088来访当问<br>        super(8088);<br>    }<br><br>    public Response serve(String uri, Method method, <br>            Map&lt;String, String&gt; header,<br>            Map&lt;String, String&gt; parameters,<br>            Map&lt;String, String&gt; files)<br>    {<br>        int len = 0;  <br>        byte[] buffer = null;<br>        <br>        // 默认传入的url是以“/”开头的，需要删除掉，否则就变成了绝对路径<br>        String file_name = uri.substring(1);<br>        <br>        // 默认的页面名称设定为index.html<br>        if(file_name.equalsIgnoreCase(&quot;&quot;)){<br>            file_name = &quot;index.html&quot;;<br>        }<br><br>        try {<br>            <br>            //通过AssetManager直接打开文件进行读取操作<br>            InputStream in = asset_mgr.open(file_name, AssetManager.ACCESS_BUFFER);<br>            <br>            //假设单个网页文件大小的上限是1MB<br>            buffer = new byte[1024*1024];  <br>            <br>            int temp=0;<br>            while((temp=in.read())!=-1){<br>                buffer[len]=(byte)temp;  <br>                len++;  <br>            }<br>            in.close();  <br>        } catch (IOException e) {<br>            // TODO Auto-generated catch block<br>            e.printStackTrace();<br>        }<br><br>        // 将读取到的文件内容返回给浏览器<br>        return new NanoHTTPD.Response(new String(buffer,0,len));<br><br>    }<br>}<br></pre><br><br>接下来，我们要在MainActivity中启动这个WebServer。<br><pre class="brush: java; gutter: true; first-line: 1; highlight: []; html-script: false"><br>public class MainActivity extends Activity {<br><br>    private SimpleServer server;<br>    @Override<br>    protected void onCreate(Bundle savedInstanceState) {<br>        super.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br>        <br>        server = new SimpleServer();<br>        try {<br>            <br>            // 因为程序模拟的是html放置在asset目录下，<br>            // 所以在这里存储一下AssetManager的指针。<br>            server.asset_mgr = this.getAssets();<br>            <br>            // 启动web服务<br>            server.start();<br>            <br>            Log.i(&quot;Httpd&quot;, &quot;The server started.&quot;);<br>        } catch(IOException ioe) {<br>            Log.w(&quot;Httpd&quot;, &quot;The server could not start.&quot;);<br>        }<br>    }<br><br>    @Override<br>    public void onDestroy()<br>    {<br>        super.onDestroy();<br>        <br>        if (server != null){<br>            // 在程序退出时关闭web服务器<br>            server.stop();<br>        }<br>        Log.w(&quot;Httpd&quot;, &quot;The server stopped.&quot;);<br>    }<br><br>    @Override<br>    public boolean onCreateOptionsMenu(Menu menu) {<br>        // Inflate the menu; this adds items to the action bar if it is present.<br>        getMenuInflater().inflate(R.menu.main, menu);<br>        return true;<br>    }<br><br>}<br></pre><br><br>还有最重要的一件事情，权限：<br><pre class="brush: xml; gutter: true; first-line: 1; highlight: []; html-script: false"><br>&lt;uses-permission android:name=&quot;android.permission.INTERNET&quot;/&gt;<br></pre><br><br>剩下的工作就是从NanoHTTPD的网站上下载NanoHTTPD.java文件放入到Android工程的src目录下，并且编译调试它。<br><br>附带一个完整的工程包以供参考（好吧，它不太完整，我删除了libs目录）<br><a href="http://blog.zeerd.com/public/2014/03/emneg.zeerd.webserver.7z">emneg.zeerd.webserver</a>