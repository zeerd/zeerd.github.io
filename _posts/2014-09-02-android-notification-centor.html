---
layout: post
title: Android消息中心信息获取与发布
tag: [Notification]
categories: [Android]
---
现如今，绝大部分腕表等可穿戴设备所能起到的主要作用还仅仅是手机第二屏（部分支持语音的设备除外）。<br>本文讲述一下如何在Android手机中获取到消息中心的实时数据，并发送给其他设备。<br>
<!--break-->
<br>因为本人对蓝牙部分不熟悉，所以这里采用了UDP的形式进行数据的发送。<br>实际上，此处主要的难点是icon图片的封装和解包。至于通讯是依赖于蓝牙还是UDP还是其他什么方式，就仅仅是发送命令不同罢了。<br><br>下面是消息中心数据的获取。实际上非常简单，只要实现了NotificationListenerService 里面的几个函数就可以了。<br><strong>MyNotificationService.java</strong><br><pre class="brush: java; gutter: true">package com.zeerd.emneg.mynotificationcenter;<br><br>import android.annotation.TargetApi;<br>import android.service.notification.NotificationListenerService;<br>import android.service.notification.StatusBarNotification;<br><br>public class MyNotificationService extends NotificationListenerService {<br>	@Override<br>	public void onNotificationPosted(StatusBarNotification arg0) {<br>		// TODO Auto-generated method stub<br>		SendNotification sn = new SendNotification(this);<br>		sn.posted(arg0);<br>	}<br><br>	@Override<br>	public void onNotificationRemoved(StatusBarNotification arg0) {<br>		// TODO Auto-generated method stub<br>		SendNotification sn = new SendNotification(this);<br>		sn.removed(arg0);<br>	}<br>}</pre><br><br>需要注意的就是要在AndroidManifest.xml文件中配置service：<br><strong>AndroidManifest.xml</strong><br><pre class="brush: xml; gutter: true">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;<br>&lt;manifest xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;<br>    package=&quot;com.zeerd.emneg.mynotificationcenter&quot;<br>    android:versionCode=&quot;1&quot;<br>    android:versionName=&quot;1.0&quot; &gt;<br><br>    &lt;uses-sdk<br>        android:minSdkVersion=&quot;8&quot;<br>        android:targetSdkVersion=&quot;19&quot; /&gt;<br><br>    &lt;uses-permission android:name=&quot;android.permission.INTERNET&quot; /&gt;  <br>    &lt;application<br>        android:allowBackup=&quot;true&quot;<br>        android:icon=&quot;@drawable/ic_launcher&quot;<br>        android:label=&quot;@string/app_name&quot;<br>        android:theme=&quot;@style/AppTheme&quot; &gt;<br>        &lt;activity<br>            android:name=&quot;com.zeerd.emneg.mynotificationcenter.MainActivity&quot;<br>            android:label=&quot;@string/app_name&quot; &gt;<br>            &lt;intent-filter&gt;<br>                &lt;action android:name=&quot;android.intent.action.MAIN&quot; /&gt;<br><br>                &lt;category android:name=&quot;android.intent.category.LAUNCHER&quot; /&gt;<br>            &lt;/intent-filter&gt;<br>        &lt;/activity&gt;<br>        &lt;service android:name=&quot;.MyNotificationService&quot;<br>            android:label=&quot;@string/service_name&quot;<br>            android:permission=&quot;android.permission.BIND_NOTIFICATION_LISTENER_SERVICE&quot;&gt;<br>             &lt;intent-filter&gt;<br>                 &lt;action android:name=&quot;android.service.notification.NotificationListenerService&quot; /&gt;<br>             &lt;/intent-filter&gt;<br>         &lt;/service&gt;<br>     &lt;/application&gt;<br><br>&lt;/manifest&gt;</pre><br><br>下面的类用于消息的打包和发送。为了便于测试，这里将消息数据通过sendBroadcast发送到了MainActivity一份。实际的使用中是不需要的。<br><strong>SendNotification.java</strong><br><pre class="brush: java; gutter: true">package com.zeerd.emneg.mynotificationcenter;<br><br>import java.lang.NullPointerException;<br><br>import java.net.DatagramPacket;<br>import java.net.DatagramSocket;<br>import java.net.InetAddress;<br>import java.net.SocketException;<br>import java.net.UnknownHostException;<br>import java.nio.ByteBuffer;<br>import android.annotation.TargetApi;<br>import android.app.Notification;<br>import android.content.Context;<br>import android.content.Intent;<br>import android.content.SharedPreferences;<br>import android.graphics.Bitmap;<br>import android.os.Bundle;<br>import android.service.notification.StatusBarNotification;<br>import android.util.Log;<br><br>public class SendNotification {<br>	final static private String TAG = &quot;SendOfMyNotification&quot;;<br><br>	private Context mContext = null;<br>	private UdpClient udpClient = null;<br><br>	public SendNotification(Context context) {<br>		mContext = context;<br>		udpClient = new UdpClient();<br>		new Thread(udpClient).start();<br><br>		SharedPreferences settings = mContext<br>				.getSharedPreferences(&quot;Setting&quot;, 0);<br>		String ip = settings.getString(&quot;server_ip&quot;, &quot;127.0.0.1&quot;);<br><br>		udpClient.setServerIp(ip, 5678);<br>		Log.d(TAG, &quot;Connect to &quot; + ip + &quot;:&quot; + 5678);<br>	}<br><br>	public boolean posted(StatusBarNotification arg0) {<br>		toActivity.posted(mContext, arg0.getNotification().extras);<br>		udpClient.posted(mContext, arg0.getId(), arg0.isOngoing(),<br>				arg0.getNotification().extras);<br>		return true;<br>	}<br><br>	public boolean removed(StatusBarNotification arg0) {<br>		toActivity.removed(mContext, arg0.getNotification().extras);<br>		udpClient.removed(mContext, arg0.getId(), arg0.isOngoing(),<br>				arg0.getNotification().extras);<br>		return true;<br>	}<br><br>	private NotificationInfo getInfo(Context c, Bundle extras) {<br>		NotificationInfo info = new NotificationInfo();<br>		info.action = NotificationInfo.ACTION_UNDEF;<br>		try {<br>			info.title = extras.getString(Notification.EXTRA_TITLE);<br>		} catch (NullPointerException e) {<br>			// e.printStackTrace();<br>		}<br><br>		try {<br>			info.icon = extras.getInt(Notification.EXTRA_SMALL_ICON);<br>		} catch (NullPointerException e) {<br>			// e.printStackTrace();<br>		}<br><br>		try {<br>			info.largeIcon = ((Bitmap) extras<br>					.getParcelable(Notification.EXTRA_LARGE_ICON));<br>		} catch (NullPointerException e) {<br>			// e.printStackTrace();<br>			try {<br>				info.largeIcon = ((Bitmap) extras<br>						.getParcelable(Notification.EXTRA_LARGE_ICON_BIG));<br>			} catch (NullPointerException e1) {<br>				// e1.printStackTrace();<br>				try {<br>					info.largeIcon = ((Bitmap) extras<br>							.getParcelable(Notification.EXTRA_PICTURE));<br>				} catch (NullPointerException e2) {<br>					// e2.printStackTrace();<br>				}<br>			}<br>		}<br><br>		try {<br>			info.text = extras.getCharSequence(Notification.EXTRA_TEXT)<br>					.toString();<br>		} catch (NullPointerException e) {<br>			// e.printStackTrace();<br>		}<br><br>		try {<br>			info.subText = extras.getCharSequence(Notification.EXTRA_SUB_TEXT)<br>					.toString();<br>		} catch (NullPointerException e) {<br>			// e.printStackTrace();<br>		}<br><br>		Log.d(TAG, &quot;Title[&quot; + info.title + &quot;] Text[&quot; + info.text + &quot;] SubText[&quot;<br>				+ info.subText + &quot;] Icon[&quot; + info.icon + &quot;] LargeIcon[&quot;<br>				+ ((info.largeIcon == null) ? &quot;false]&quot; : &quot;true]&quot;));<br>		return info;<br>	}<br><br>	private static class NotificationInfo {<br>		public static final int ACTION_UNDEF = 0;<br>		public static final int ACTION_POSTED = 1;<br>		public static final int ACTION_REMOVED = 2;<br><br>		public String title = &quot;&quot;;<br>		public String text = &quot;&quot;;<br>		public String subText = &quot;&quot;;<br>		public int icon = -1;<br>		public Bitmap largeIcon = null;<br>		public int action = ACTION_UNDEF;<br>		public int id = -1;<br>		boolean isOngoing = false;<br>	}<br><br>	// for easy testing , we send the notification&#039;s infos to the MainActivity,<br>	// too.<br>	public static class toActivity {<br>		public static boolean posted(Context c, Bundle extras) {<br>			Intent intent = new Intent(MainActivity.INTENT_ACTION_NOTIFICATION);<br>			intent.putExtras(extras);<br>			c.sendBroadcast(intent);<br>			return true;<br>		}<br><br>		public static boolean removed(Context c, Bundle extras) {<br>			Intent intent = new Intent(MainActivity.INTENT_ACTION_NOTIFICATION);<br>			intent.putExtras(extras);<br>			c.sendBroadcast(intent);<br>			return true;<br>		}<br>	}<br><br>	public class UdpClient implements Runnable {<br>		private InetAddress serverAddr = null;<br>		DatagramSocket socket = null;<br>		private int port = 0;<br>		private NotificationInfo info = null;<br><br>		public void setServerIp(String ip, int p) {<br>			try {<br>				serverAddr = InetAddress.getByName(ip);<br>			} catch (UnknownHostException e) {<br>				e.printStackTrace();<br>			}<br>			port = p;<br>		}<br><br>		public boolean posted(Context c, int id, boolean isOngoing,<br>				Bundle extras) {<br>			info = getInfo(c, extras);<br>			info.action = NotificationInfo.ACTION_POSTED;<br>			info.id = id;<br>			info.isOngoing = isOngoing;<br>			return true;<br>		}<br><br>		public boolean removed(Context c, int id, boolean isOngoing,<br>				Bundle extras) {<br>			info = getInfo(c, extras);<br>			info.action = NotificationInfo.ACTION_REMOVED;<br>			info.id = id;<br>			info.isOngoing = isOngoing;<br>			return true;<br>		}<br><br>		private byte[] makeSendBuf() {<br>			byte[] buf;<br>			byte[] id = intToByteArray(info.id);<br>			byte[] idLen = intToByteArray(id.length);<br>			byte[] isOngoing = intToByteArray(info.isOngoing ? 1 : 0);<br>			byte[] isOngoingLen = intToByteArray(isOngoing.length);<br>			byte[] title = info.title.getBytes();<br>			byte[] titleLen = intToByteArray(title.length);<br>			byte[] text = info.text.getBytes();<br>			byte[] textLen = intToByteArray(text.length);<br>			byte[] sub = info.subText.getBytes();<br>			byte[] subLen = intToByteArray(sub.length);<br>			byte[] icon = intToByteArray(info.icon);<br>			byte[] iconLen = intToByteArray(icon.length);<br>			byte[] largeIcon = bitmapToByteArray(info.largeIcon);<br>			byte[] largeIconWidth = null;<br>			byte[] largeIconHeight = null;<br>			if (info.largeIcon != null) {<br>				largeIconWidth = intToByteArray(info.largeIcon.getWidth());<br>				largeIconHeight = intToByteArray(info.largeIcon.getHeight());<br>			}<br>			byte[] largeIconLen = intToByteArray((largeIcon == null) ? 0<br>					: info.largeIcon.getByteCount());<br><br>			buf = concatBytes(idLen, id);<br>			buf = concatBytes(buf, isOngoingLen);<br>			buf = concatBytes(buf, isOngoing);<br>			buf = concatBytes(buf, titleLen);<br>			buf = concatBytes(buf, title);<br>			buf = concatBytes(buf, textLen);<br>			buf = concatBytes(buf, text);<br>			buf = concatBytes(buf, subLen);<br>			buf = concatBytes(buf, sub);<br>			buf = concatBytes(buf, iconLen);<br>			buf = concatBytes(buf, icon);<br>			buf = concatBytes(buf, largeIconLen);<br>			buf = concatBytes(buf, largeIconWidth);<br>			buf = concatBytes(buf, largeIconHeight);<br>			buf = concatBytes(buf, largeIcon);<br><br>			return buf;<br>		}<br><br>		@Override<br>		public void run() {<br>			if (serverAddr == null) {<br>				return;<br>			}<br><br>			Log.d(TAG, &quot;Client: Start connecting\\n&quot;);<br>			try {<br>				socket = new DatagramSocket();<br>			} catch (SocketException e2) {<br>				e2.printStackTrace();<br>			}<br><br>			while (true) {<br>				try {<br>					Thread.sleep(500);<br>				} catch (InterruptedException e1) {<br>					e1.printStackTrace();<br>				}<br>				if (info != null) {<br>					try {<br>						byte[] buf = makeSendBuf();<br>						// the max size of the send buffer is 4097. we made the<br>						// send buffer to 4000 for prefix and reserve.<br>						// the prefix protocol format is:<br>						// byte1 : action<br>						// byte2~5 : the start offset (unit by byte) in the<br>						// whole sending buffer<br>						// byte6~9 : the total size of the sending buffer<br>						for (int i = 0; i &lt; buf.length; i += 4000) {<br>							byte[] s = new byte[4009], n, t;<br>							int sLen = ((buf.length - i) &lt; 4000) ? buf.length<br>									- i : 4000;<br>							n = intToByteArray(i);<br>							t = intToByteArray(buf.length);<br>							s[0] = (byte) info.action;<br>							System.arraycopy(n, 0, s, 1, 4);<br>							System.arraycopy(t, 0, s, 5, 4);<br>							System.arraycopy(buf, i, s, 9, sLen);<br><br>							DatagramPacket packet = new DatagramPacket(s,<br>									sLen + 8, serverAddr, port);<br>							socket.send(packet);<br>						}<br>						Log.d(TAG, &quot;Client: Message sent\\n&quot;);<br>					} catch (Exception e) {<br>						Log.d(TAG, &quot;Client: Error!\\n&quot;);<br>						e.printStackTrace();<br>					}<br>					info = null;<br>				}<br>			}<br>		}<br>	}<br><br>	private static byte[] intToByteArray(int a) {<br>		byte[] ret = new byte[4];<br>		ret[3] = (byte) (a &amp; 0xFF);<br>		ret[2] = (byte) ((a &gt;&gt; 8) &amp; 0xFF);<br>		ret[1] = (byte) ((a &gt;&gt; 16) &amp; 0xFF);<br>		ret[0] = (byte) ((a &gt;&gt; 24) &amp; 0xFF);<br>		return ret;<br>	}<br><br>	private static byte[] bitmapToByteArray(Bitmap b) {<br>		if (b != null) {<br>			int bytes = b.getByteCount();<br>			ByteBuffer buffer = ByteBuffer.allocate(bytes);<br>			b.copyPixelsToBuffer(buffer);<br>			return buffer.array();<br>		} else {<br>			return null;<br>		}<br>	}<br><br>	private static byte[] concatBytes(byte[] a, byte[] b) {<br>		if (b == null) {<br>			return a;<br>		} else {<br>			byte[] c = new byte[a.length + b.length];<br>			System.arraycopy(a, 0, c, 0, a.length);<br>			System.arraycopy(b, 0, c, a.length, b.length);<br>			return c;<br>		}<br>	}<br>}</pre><br><br><strong>MainActivity.java</strong><br><pre class="brush: java; gutter: true">package com.zeerd.emneg.mynotificationcenter;<br><br>import java.util.Properties;<br><br>import android.os.Bundle;<br>import android.annotation.TargetApi;<br>import android.app.Activity;<br>import android.app.Notification;<br>import android.app.NotificationManager;<br>import android.content.BroadcastReceiver;<br>import android.content.Context;<br>import android.content.Intent;<br>import android.content.IntentFilter;<br>import android.content.SharedPreferences;<br>import android.content.SharedPreferences.Editor;<br>import android.graphics.Bitmap;<br>import android.graphics.BitmapFactory;<br>import android.view.Menu;<br>import android.view.View;<br>import android.view.View.OnClickListener;<br>import android.widget.Button;<br>import android.widget.EditText;<br>import android.widget.ImageView;<br>import android.widget.TextView;<br><br>@TargetApi(19)<br>public class MainActivity extends Activity {<br><br>	public static String INTENT_ACTION_NOTIFICATION = &quot;com.zeerd.emneg.mynotificationcenter.notification&quot;;<br>	NotificationManager mNotificationMgr = null;<br>	Button mBtn = null;<br>	Context mContext = this;<br>	protected Properties properties = null;<br><br>	protected TextView title;<br>	protected TextView text;<br>	protected TextView subtext;<br>	protected ImageView largeIcon;<br>	protected EditText etIp;<br><br>	protected MyReceiver mReceiver = new MyReceiver();<br><br>	@Override<br>	protected void onCreate(Bundle savedInstanceState) {<br>		super.onCreate(savedInstanceState);<br>		setContentView(R.layout.activity_main);<br><br>		properties = new Properties();<br>		mNotificationMgr = (NotificationManager) this<br>				.getSystemService(Context.NOTIFICATION_SERVICE);<br><br>		title = (TextView) findViewById(R.id.nt_title);<br>		text = (TextView) findViewById(R.id.nt_text);<br>		subtext = (TextView) findViewById(R.id.nt_subtext);<br>		largeIcon = (ImageView) findViewById(R.id.nt_largeicon);<br>		etIp = (EditText) findViewById(R.id.editText1);<br><br>		mBtn = (Button) findViewById(R.id.button1);<br>		mBtn.setOnClickListener(new OnClickListener() {<br>			@Override<br>			public void onClick(View v) {<br>				writeProperties();<br><br>				Bitmap aBitmap = BitmapFactory.decodeResource(getResources(),<br>						R.drawable.ic_launcher);<br>				Notification.Builder b = new Notification.Builder(mContext);<br>				b.setContentTitle(&quot;Test&quot;);<br>				b.setContentText(&quot;subject&quot;);<br>				b.setSubText(&quot;content&quot;);<br>				b.setSmallIcon(R.drawable.ic_launcher);<br>				b.setLargeIcon(aBitmap);<br>				Notification n = b.build();<br><br>				mNotificationMgr.notify(null, 0, n);<br>			}<br>		});<br>	}<br><br>	@Override<br>	public boolean onCreateOptionsMenu(Menu menu) {<br>		// Inflate the menu; this adds items to the action bar if it is present.<br>		getMenuInflater().inflate(R.menu.main, menu);<br>		return true;<br>	}<br><br>	@Override<br>	protected void onResume() {<br>		super.onResume();<br>		if (mReceiver == null)<br>			mReceiver = new MyReceiver();<br>		registerReceiver(mReceiver,<br>				new IntentFilter(INTENT_ACTION_NOTIFICATION));<br>	}<br><br>	@Override<br>	protected void onPause() {<br>		super.onPause();<br>		unregisterReceiver(mReceiver);<br>	}<br><br>	@TargetApi(19)<br>	public class MyReceiver extends BroadcastReceiver {<br><br>		@Override<br>		public void onReceive(Context context, Intent intent) {<br><br>			if (intent != null) {<br>				Bundle extras = intent.getExtras();<br>				String notificationTitle = extras<br>						.getString(Notification.EXTRA_TITLE);<br>				Bitmap notificationLargeIcon = ((Bitmap) extras<br>						.getParcelable(Notification.EXTRA_LARGE_ICON));<br>				CharSequence notificationText = extras<br>						.getCharSequence(Notification.EXTRA_TEXT);<br>				CharSequence notificationSubText = extras<br>						.getCharSequence(Notification.EXTRA_SUB_TEXT);<br><br>				title.setText(notificationTitle);<br>				text.setText(notificationText);<br>				subtext.setText(notificationSubText);<br><br>				if (notificationLargeIcon != null) {<br>					largeIcon.setImageBitmap(notificationLargeIcon);<br>				}<br>			}<br>		}<br>	}<br><br>	private void writeProperties() {<br>		SharedPreferences settings = mContext<br>				.getSharedPreferences(&quot;Setting&quot;, 0);<br>		Editor editor = settings.edit();<br>		editor.putString(&quot;server_ip&quot;, etIp.getText().toString());<br>		editor.commit();<br>	}<br>}</pre><br><br>接收端的代码如下：<br><pre class="brush: java; gutter: true">package com.zeerd.emneg.mynotificationreceiver;<br><br>import java.net.DatagramPacket;<br>import java.net.DatagramSocket;<br>import java.nio.ByteBuffer;<br>import java.util.ArrayList;<br>import java.util.List;<br><br>import android.os.Bundle;<br>import android.os.Handler;<br>import android.os.Message;<br>import android.annotation.SuppressLint;<br>import android.app.Activity;<br>import android.content.Context;<br>import android.graphics.Bitmap;<br>import android.util.Log;<br>import android.view.LayoutInflater;<br>import android.view.Menu;<br>import android.view.View;<br>import android.view.ViewGroup;<br>import android.widget.BaseAdapter;<br>import android.widget.ImageView;<br>import android.widget.ListAdapter;<br>import android.widget.ListView;<br>import android.widget.TextView;<br><br>public class MainActivity extends Activity {<br>	private static final String TAG = &quot;ReceiverOfMyNotification&quot;;<br>	public static final int SERVERPORT = 5678;<br>	public Context mContext = this;<br><br>	public ListView mListViewOngoing;<br>	public ListView mListViewNonOngoing;<br><br>	public List&lt;NotificationInfo&gt; mOngoingList;<br>	public List&lt;NotificationInfo&gt; mNonOngoingList;<br><br>	public Handler handler;<br><br>	@SuppressLint(&quot;HandlerLeak&quot;)<br>	@Override<br>	protected void onCreate(Bundle savedInstanceState) {<br>		super.onCreate(savedInstanceState);<br>		setContentView(R.layout.activity_main);<br><br>		mOngoingList = new ArrayList&lt;NotificationInfo&gt;();<br>		mNonOngoingList = new ArrayList&lt;NotificationInfo&gt;();<br><br>		mListViewOngoing = (ListView) findViewById(R.id.listView2);<br>		mListViewNonOngoing = (ListView) findViewById(R.id.listView1);<br><br>		handler = new Handler() {<br>			@Override<br>			public void handleMessage(Message msg) {<br>				NotificationInfo info = (NotificationInfo) msg.obj;<br><br>				if (info.isOngoing) {<br>					mOngoingList.add(0, info);<br>					ListAdapter list = new OngoingAdapter(mContext);<br>					mListViewOngoing.setAdapter(list);<br>				} else {<br>					mNonOngoingList.add(0, info);<br>					ListAdapter list1 = new NonOngoingAdapter(mContext);<br>					mListViewNonOngoing.setAdapter(list1);<br>				}<br><br>			}<br>		};<br><br>		new Thread(new Server()).start();<br>	}<br><br>	@Override<br>	public boolean onCreateOptionsMenu(Menu menu) {<br>		// Inflate the menu; this adds items to the action bar if it is present.<br>		getMenuInflater().inflate(R.menu.main, menu);<br>		return true;<br>	}<br><br>	public class Server implements Runnable {<br>		byte[] fullBuf = new byte[100 * 1024];<br><br>		@Override<br>		public void run() {<br>			try {<br>				Log.d(TAG, &quot;Server: Start connecting&quot;);<br>				@SuppressWarnings(&quot;resource&quot;)<br>				DatagramSocket socket = new DatagramSocket(SERVERPORT);<br>				byte[] buf = new byte[4097];<br>				DatagramPacket packet = new DatagramPacket(buf, buf.length);<br>				while (true) {<br>					socket.receive(packet);<br><br>					int index = byteArrayToInt(buf, 1);<br>					int total = byteArrayToInt(buf, 5);<br><br>					if ((total - index) &lt; 4000) {<br><br>						Log.d(TAG, &quot;Server: Receiving&quot; + index + &quot;/&quot; + total);<br>						System.arraycopy(buf, 9, fullBuf, index, total - index);<br><br>						String debug_log = &quot;&quot;;<br>						for (int i = 0; i &lt; 100; i++) {<br>							debug_log += &quot; &quot;<br>									+ Integer.toString((int) fullBuf[i], 16);<br>						}<br>						Log.d(TAG, &quot;Server: Receiving[0..100] &quot; + debug_log);<br><br>						NotificationInfo info = getInfo(fullBuf);<br>						info.action = (int) buf[0];<br><br>						Log.d(TAG, &quot;Title[&quot;<br>								+ info.title<br>								+ &quot;] Text[&quot;<br>								+ info.text<br>								+ &quot;] SubText[&quot;<br>								+ info.subText<br>								+ &quot;] Icon[&quot;<br>								+ info.icon<br>								+ &quot;] LargeIcon[&quot;<br>								+ ((info.largeIcon == null) ? &quot;false]&quot;<br>										: &quot;true]&quot;));<br><br>						Message msg = handler.obtainMessage(0, info);<br>						handler.sendMessage(msg);<br><br>					} else {<br>						Log.d(TAG, &quot;Server: Receiving&quot; + index + &quot;/&quot; + total);<br>						System.arraycopy(buf, 9, fullBuf, index, 4000);<br>					}<br><br>				}<br><br>			} catch (Exception e) {<br>				e.printStackTrace();<br>			}<br>		}<br>	}<br><br>	private static class NotificationInfo {<br>		public static final int ACTION_UNDEF = 0;<br>		public static final int ACTION_POSTED = 1;<br>		@SuppressWarnings(&quot;unused&quot;)<br>		public static final int ACTION_REMOVED = 2;<br><br>		public String title = &quot;&quot;;<br>		public String text = &quot;&quot;;<br>		public String subText = &quot;&quot;;<br>		public int icon = -1;<br>		public Bitmap largeIcon = null;<br>		public int action = ACTION_UNDEF;<br>		public int id = -1;<br>		boolean isOngoing = false;<br>	}<br><br>	private NotificationInfo getInfo(byte[] buf) {<br>		int idx = 0;<br>		int len = 0;<br>		byte[] text = null;<br>		NotificationInfo info = new NotificationInfo();<br><br>		try {<br>			len = byteArrayToInt(buf, idx);<br>			text = new byte[len];<br>			System.arraycopy(buf, idx + 4, text, 0, len);<br>			idx += (4 + len);<br>			info.id = byteArrayToInt(text, 0);<br><br>			len = byteArrayToInt(buf, idx);<br>			text = new byte[len];<br>			System.arraycopy(buf, idx + 4, text, 0, len);<br>			idx += (4 + len);<br>			info.isOngoing = (byteArrayToInt(text, 0) == 0) ? false : true;<br><br>			len = byteArrayToInt(buf, idx);<br>			text = new byte[len];<br>			System.arraycopy(buf, idx + 4, text, 0, len);<br>			idx += (4 + len);<br>			info.title = new String(text);<br><br>			len = byteArrayToInt(buf, idx);<br>			text = new byte[len];<br>			System.arraycopy(buf, idx + 4, text, 0, len);<br>			idx += (4 + len);<br>			info.text = new String(text);<br><br>			len = byteArrayToInt(buf, idx);<br>			text = new byte[len];<br>			System.arraycopy(buf, idx + 4, text, 0, len);<br>			idx += (4 + len);<br>			info.subText = new String(text);<br><br>			len = byteArrayToInt(buf, idx);<br>			Log.d(TAG, &quot;len of icon=&quot; + len + &quot; idx=&quot; + idx);<br>			if (len &gt; 0) {<br>				text = new byte[len];<br>				System.arraycopy(buf, idx + 4, text, 0, len);<br>				info.icon = byteArrayToInt(text, 0);<br>			}<br>			idx += (4 + len);<br><br>			len = byteArrayToInt(buf, idx);<br>			Log.d(TAG, &quot;len of large icon=&quot; + len + &quot; idx=&quot; + idx);<br>			if (len &gt; 0) {<br>				byte[] num = new byte[4];<br>				System.arraycopy(buf, idx + 4, num, 0, 4);<br>				int w = byteArrayToInt(num, 0);<br>				System.arraycopy(buf, idx + 8, num, 0, 4);<br>				int h = byteArrayToInt(num, 0);<br><br>				text = new byte[len];<br>				System.arraycopy(buf, idx + 12, text, 0, len);<br>				ByteBuffer buffer = ByteBuffer.allocate(len);<br>				buffer.put(text);<br>				buffer.rewind();<br><br>				info.largeIcon = Bitmap.createBitmap(w, h,<br>						Bitmap.Config.ARGB_8888);<br>				info.largeIcon.copyPixelsFromBuffer(buffer);<br>			}<br>		} catch (Exception e) {<br>			e.printStackTrace();<br>		}<br><br>		return info;<br>	}<br><br>	public static int byteArrayToInt(byte[] b, int idx) {<br>		return b[3 + idx] &amp; 0xFF | (b[2 + idx] &amp; 0xFF) &lt;&lt; 8<br>				| (b[1 + idx] &amp; 0xFF) &lt;&lt; 16 | (b[0 + idx] &amp; 0xFF) &lt;&lt; 24;<br>	}<br><br>	public class OngoingAdapter extends BaseAdapter {<br><br>		LayoutInflater mInflator;<br>		private Context mContext;<br><br>		public OngoingAdapter(Context c) {<br>			mContext = c;<br>			mInflator = LayoutInflater.from(mContext);<br>		}<br><br>		@Override<br>		public int getCount() {<br>			return mOngoingList.size();<br>		}<br><br>		@Override<br>		public Object getItem(int arg0) {<br>			if (mOngoingList != null) {<br>				return mOngoingList.get(arg0);<br>			} else {<br>				return null;<br>			}<br>		}<br><br>		@Override<br>		public long getItemId(int arg0) {<br>			return arg0;<br>		}<br><br>		@Override<br>		public View getView(int position, View convertView, ViewGroup parent) {<br>			convertView = mInflator.inflate(R.layout.listitem, parent, false);<br><br>			if ((convertView != null) &amp;&amp; (mOngoingList != null)) {<br>				NotificationInfo info = (NotificationInfo) mOngoingList<br>						.get(position);<br>				getListVIew(convertView, info);<br>			}<br><br>			return convertView;<br>		}<br><br>	}<br><br>	public class NonOngoingAdapter extends BaseAdapter {<br><br>		LayoutInflater mInflator;<br>		private Context mContext;<br><br>		public NonOngoingAdapter(Context c) {<br>			mContext = c;<br>			mInflator = LayoutInflater.from(mContext);<br>		}<br><br>		@Override<br>		public int getCount() {<br>			return mNonOngoingList.size();<br>		}<br><br>		@Override<br>		public Object getItem(int arg0) {<br>			if (mNonOngoingList != null) {<br>				return mNonOngoingList.get(arg0);<br>			} else {<br>				return null;<br>			}<br>		}<br><br>		@Override<br>		public long getItemId(int arg0) {<br>			return arg0;<br>		}<br><br>		@Override<br>		public View getView(int position, View convertView, ViewGroup parent) {<br>			convertView = mInflator.inflate(R.layout.listitem, parent, false);<br><br>			if ((convertView != null) &amp;&amp; (mNonOngoingList != null)) {<br>				NotificationInfo info = (NotificationInfo) mNonOngoingList<br>						.get(position);<br>				getListVIew(convertView, info);<br>			}<br><br>			return convertView;<br>		}<br>	}<br><br>	private void getListVIew(View convertView, NotificationInfo info) {<br>		TextView tvTitle = (TextView) convertView.findViewById(R.id.text1);<br>		TextView tvText = (TextView) convertView.findViewById(R.id.text2);<br>		ImageView iconView = (ImageView) convertView.findViewById(R.id.icon);<br><br>		Log.d(TAG, &quot;Set Title[&quot; + info.title + &quot;] Text[&quot; + info.text<br>				+ &quot;] SubText[&quot; + info.subText + &quot;] Icon[&quot; + info.icon<br>				+ &quot;] LargeIcon[&quot;<br>				+ ((info.largeIcon == null) ? &quot;false]&quot; : &quot;true]&quot;));<br><br>		tvTitle.setText(((info.action == NotificationInfo.ACTION_POSTED) ? &quot;[+]&quot;<br>				: &quot;[-]&quot;) + info.title);<br>		tvText.setText(&quot;(&quot; + info.id + &quot;)&quot; + info.text + &quot;[&quot; + info.subText<br>				+ &quot;]&quot;);<br>		iconView.setImageBitmap(info.largeIcon);<br>	}<br>}</pre><br><br><strong>listitem.xml</strong><br><pre class="brush: xml; gutter: true"><br>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;<br>&lt;RelativeLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;<br>    android:layout_width=&quot;match_parent&quot;<br>    android:layout_height=&quot;wrap_content&quot; &gt;<br><br>    &lt;ImageView<br>        android:id=&quot;@+id/icon&quot;<br>        android:layout_width=&quot;40dp&quot;<br>        android:layout_height=&quot;40dp&quot;<br>        android:layout_alignParentBottom=&quot;true&quot;<br>        android:layout_alignParentLeft=&quot;true&quot;<br>        android:layout_alignParentTop=&quot;true&quot; /&gt;<br><br>    &lt;TextView<br>        android:id=&quot;@+id/text1&quot;<br>        android:textStyle=&quot;bold&quot;<br>        android:layout_width=&quot;match_parent&quot;<br>        android:layout_height=&quot;wrap_content&quot;<br>        android:layout_marginLeft=&quot;5dp&quot;<br>        android:layout_marginTop=&quot;6dp&quot;<br>        android:layout_toRightOf=&quot;@id/icon&quot; /&gt;<br><br>    &lt;TextView<br>        android:id=&quot;@+id/text2&quot;<br>        android:layout_width=&quot;match_parent&quot;<br>        android:layout_height=&quot;wrap_content&quot;<br>        android:layout_alignStart=&quot;@id/text1&quot;<br>        android:layout_below=&quot;@id/text1&quot;<br>        android:layout_toRightOf=&quot;@id/icon&quot;<br>        android:textAppearance=&quot;?android:attr/textAppearanceSmall&quot; /&gt;<br><br>&lt;/RelativeLayout&gt;</pre><br>
<br>效果如下：<br><a href="http://blog.zeerd.com/public/2014/09/nc1.png"><img src="http://blog.zeerd.com/public/2014/09/nc1.png" alt="nc" width="270" height="415" class="alignnone size-full wp-image-935" /></a>
