---
layout: post
title: Linux系统，在不真正添加用户的情况下进行文件系统权限管理
tag: [FileSystem]
categories: [Linux]
---
<!--break-->
下面的程序在测试时需要以root权限运行：<br><br>首先，程序会以root权限创建一个目录和一个文件，并在文件中写入“Hello,world!”。<br><br>然后，用chmod函数对目录和文件进行权限设定（注意：系统中并不存在一个id为1010的账户），同时将目录和文件权限设置为仅有所有者可以读写。并尝试使用root权限进行读取。可以看到读取能够成功。<br><br>接下来，调用setegid/seteuid将可执行程序本身用户和组设置为不存在的1010，并验证可以正常读写。<br><br>再继续，将执行程序本身用户和组设置为另一个不存在的1011。因为之前设置过文件只有1010可以读写，所以这里的读写会失败。<br><br>最后，将执行程序本身用户和组设置为不存在的1011，但是通过setgroups函数将可执行文件加入到1010组中。同时设置目录和文件为同组可读写。结果是读写都可以成功。<br><br><pre class="brush: c; gutter: true">#include &lt;stdio.h&gt;<br>#include &lt;stdlib.h&gt;<br>#include &lt;unistd.h&gt;<br><br>int main(int argc, char *argv[])<br>{<br>	char* folder = argv[1];mkdir(folder, 0755);<br>	char* file = NULL;asprintf(&amp;file, &quot;%s/test&quot;, folder);<br><br>	/* create a single file with root right */<br>	FILE *fp = fopen(file, &quot;w&quot;);<br>	if(fp != NULL) {<br>		fprintf(fp, &quot;Hello,world!\\n&quot;);<br>		fclose(fp);<br>	}<br><br>	/* set the owner of those to a non-exist user-id and group-id */<br>	chown(folder, 1010, 1010);<br>	chown(file, 1010, 1010);<br>	/* and set the owner could read and write it only */<br>	chmod(folder, 0700);<br>	chmod(file, 0600);<br><br>	/* testing for the root user, root could read and write it as wish. */<br>	fp = fopen(file, &quot;r&quot;);<br>	if(fp != NULL) {<br>		char word[100] = &quot;&quot;;<br>		fscanf(fp, &quot;%s&quot;, word);<br>		printf(&quot;root read %s\\n&quot;, word);<br>		fclose(fp);<br>	} else {<br>		perror(&quot;root read&quot;);<br>	}<br><br>	/* change the user-id and group-id of the executable-program-self to the <br>	   non-exist user-id and group-id */<br>	/* maybe setuid()/setgid() were more safer here. <br>	   but we want to change the user-id and group-id again later, so use <br>	   seteuid()/setegid() here for this testing. */<br>	setegid(1010);<br>	seteuid(1010);<br><br>	/* the reading and writing could be done as wish. */<br>	fp = fopen(file, &quot;r&quot;);<br>	if(fp != NULL) {<br>		char word[100] = &quot;&quot;;<br>		fscanf(fp, &quot;%s&quot;, word);<br>		printf(&quot;1010 read %s\\n&quot;, word);<br>		fclose(fp);<br>	} else {<br>		perror(&quot;1010 read&quot;);<br>	}<br><br>	fp = fopen(file, &quot;w&quot;);<br>	if(fp != NULL) {<br>		fprintf(fp, &quot;Hello,again!\\n&quot;);<br>		fclose(fp);<br>	} else {<br>		perror(&quot;1010 write&quot;);<br>	}<br><br>	fp = fopen(file, &quot;r&quot;);<br>	if(fp != NULL) {<br>		char word[100] = &quot;&quot;;<br>		fscanf(fp, &quot;%s&quot;, word);<br>		printf(&quot;1010 read %s\\n&quot;, word);<br>		fclose(fp);<br>	} else {<br>		perror(&quot;1010 read&quot;);<br>	}<br><br>	/* change the user-id and group-id of the executable-program-self to <br>	   another non-exist user-id and group-id */<br>	setgid(0);<br>	setuid(0);<br>	setegid(1011);<br>	seteuid(1011);<br><br>	/* the reading and writing could not be done as wish. */<br>	fp = fopen(file, &quot;w&quot;);<br>	if(fp != NULL) {<br>		fprintf(fp, &quot;Hello,third!\\n&quot;);<br>		fclose(fp);<br>	} else {<br>		perror(&quot;1010 write&quot;);<br>	}<br><br>	fp = fopen(file, &quot;r&quot;);<br>	if(fp != NULL) {<br>		char word[100] = &quot;&quot;;<br>		fscanf(fp, &quot;%s&quot;, word);<br>		printf(&quot;1011 read %s\\n&quot;, word);<br>		fclose(fp);<br>	} else {<br>		perror(&quot;1011 read&quot;);<br>	}<br><br>	/* add the program to group 1010 */<br>	setgid(0);<br>	setuid(0);<br>	const gid_t grps[]={1010};<br>	setgroups(1, grps);<br>	chmod(folder, 0770);<br>	chmod(file, 0660);<br>	setegid(1011);<br>	seteuid(1011);<br><br>	/* the reading and writing could be done as wish. */<br>	fp = fopen(file, &quot;w&quot;);<br>	if(fp != NULL) {<br>		fprintf(fp, &quot;Hello,fourth!\\n&quot;);<br>		fclose(fp);<br>	} else {<br>		perror(&quot;1010 write&quot;);<br>	}<br><br>	fp = fopen(file, &quot;r&quot;);<br>	if(fp != NULL) {<br>		char word[100] = &quot;&quot;;<br>		fscanf(fp, &quot;%s&quot;, word);<br>		printf(&quot;1011 read %s\\n&quot;, word);<br>		fclose(fp);<br>	} else {<br>		perror(&quot;1011 read&quot;);<br>	}<br><br>	free(file);<br><br>	return 0;<br>}</pre>